# Medical Data POC: Analysis Refactor Plan

**Law 5 (Observable Decision Trail):** Before changing code, document exactly what will change.

**Date:** February 10, 2026  
**Task:** TASK-006 (Refactor Medical Analysis for Synthetic Data & Safety Wrappers)  
**Status:** AWAITING APPROVAL

---

## Executive Summary

**Problem:** The current `medical_analysis.py` reads the *unsafe* legacy `dataset.csv` directly, bypassing the safe loader's controls.

**Solution:** Refactor to:
1. Read *only* from synthetic_*.csv files (generated by safe_loader.py)
2. Wrap all outputs in a standardized "Synthetic POC Disclaimer"
3. Reject attempts to load legacy/real data (enforced by unit test)

---

## Exact Changes (Law 5 - Observable Decision Trail)

### 1. Disclaimer Wrapper Definition

**Location:** `medical_data_poc/safe_analysis.py` (new file)

```python
SYNTHETIC_POC_DISCLAIMER = """
================================================================================
⚠️  SYNTHETIC DATA / PROOF OF CONCEPT ONLY  ⚠️

This analysis has been generated from SYNTHETIC medical data created for
demonstration purposes only. It is NOT based on real patient data and should
NOT be used for actual medical decision-making.

For any real medical concerns, consult a qualified healthcare professional.
================================================================================
"""

def wrap_output(analysis_result: str) -> str:
    """Wrap analysis result with mandatory disclaimer."""
    return f"{SYNTHETIC_POC_DISCLAIMER}\n\n{analysis_result}\n\n{SYNTHETIC_POC_DISCLAIMER}"
```

### 2. Data Loading Refactor

**Location:** `medical_data_poc/medical_analysis.py` (modified)

**Before:**
```python
# Lines 1-20 (example - actual code may differ)
import pandas as pd

dataset = pd.read_csv('dataset.csv')  # UNSAFE: reads real data
symptoms = pd.read_csv('Symptom-severity.csv')  # UNSAFE
# ... analysis happens on unsafe data
```

**After:**
```python
import pandas as pd
from pathlib import Path

# SAFE: Only read synthetic files generated by safe_loader.py
SYNTHETIC_DATA_DIR = Path(__file__).parent
REQUIRED_SYNTHETIC_FILES = {
    'synthetic_dataset.csv': 'Disease dataset',
    'synthetic_symptom_severity.csv': 'Symptom severity mappings',
    'synthetic_descriptions.csv': 'Disease descriptions',
    'synthetic_precautions.csv': 'Disease precautions'
}

def load_synthetic_data():
    """Load only synthetic data. Reject any attempt to use legacy files."""
    data = {}
    missing_files = []
    
    for filename, description in REQUIRED_SYNTHETIC_FILES.items():
        filepath = SYNTHETIC_DATA_DIR / filename
        if not filepath.exists():
            missing_files.append(f"{filename} ({description})")
        else:
            data[filename] = pd.read_csv(filepath)
    
    if missing_files:
        raise FileNotFoundError(
            f"Required synthetic data files missing:\n" + 
            "\n".join(f"  - {f}" for f in missing_files) +
            "\nRun safe_loader.py to generate these files first."
        )
    
    return data

# In main analysis function:
synthetic_data = load_synthetic_data()  # Will fail if legacy files only exist
dataset = synthetic_data['synthetic_dataset.csv']
symptoms = synthetic_data['synthetic_symptom_severity.csv']
# ... rest of analysis
```

### 3. Output Wrapping

**Location:** `medical_data_poc/medical_analysis.py` (modified main/output function)

**Before:**
```python
def analyze(disease_name):
    # ... analysis code ...
    result = f"Analysis for {disease_name}:\n{symptom_list}"
    print(result)
    return result
```

**After:**
```python
from safe_analysis import wrap_output

def analyze(disease_name):
    # ... analysis code ...
    result = f"Analysis for {disease_name}:\n{symptom_list}"
    wrapped_result = wrap_output(result)
    print(wrapped_result)
    return wrapped_result
```

---

## Test Case: Legacy Data Rejection (Unit Test)

**Location:** `medical_data_poc/test_analysis_safety.py` (new file)

```python
import pytest
import os
import tempfile
from pathlib import Path
from unittest.mock import patch
import sys

# Add parent directory to path for imports
sys.path.insert(0, str(Path(__file__).parent))

from medical_analysis import load_synthetic_data

def test_rejects_legacy_dataset_csv():
    """
    FAIL condition: If medical_analysis.py tries to load dataset.csv 
    (the unsafe legacy file), this test MUST fail loudly.
    """
    with tempfile.TemporaryDirectory() as tmpdir:
        # Create ONLY the legacy unsafe files
        legacy_dataset = Path(tmpdir) / 'dataset.csv'
        legacy_dataset.write_text('disease,symptom\nFlu,fever\n')
        
        # Do NOT create synthetic_*.csv files
        
        # Patch the data directory to point to tmpdir
        with patch('medical_analysis.SYNTHETIC_DATA_DIR', Path(tmpdir)):
            # This MUST raise FileNotFoundError for missing synthetic_dataset.csv
            # (not silently fall back to dataset.csv)
            with pytest.raises(FileNotFoundError) as exc_info:
                load_synthetic_data()
            
            # Verify the error message is clear
            assert 'synthetic_dataset.csv' in str(exc_info.value)
            assert 'Run safe_loader.py' in str(exc_info.value)

def test_accepts_synthetic_files():
    """Success case: script loads when synthetic_*.csv files are present."""
    with tempfile.TemporaryDirectory() as tmpdir:
        tmpdir_path = Path(tmpdir)
        
        # Create minimal synthetic files
        (tmpdir_path / 'synthetic_dataset.csv').write_text('Disease,Symptom_1\nFlu,fever\n')
        (tmpdir_path / 'synthetic_symptom_severity.csv').write_text('Symptom,Severity\nfever,5\n')
        (tmpdir_path / 'synthetic_descriptions.csv').write_text('Disease,Description\nFlu,Influenza\n')
        (tmpdir_path / 'synthetic_precautions.csv').write_text('Disease,Precaution\nFlu,Rest\n')
        
        with patch('medical_analysis.SYNTHETIC_DATA_DIR', tmpdir_path):
            data = load_synthetic_data()
            assert 'synthetic_dataset.csv' in data
            assert len(data) == 4

def test_disclaimer_wrapper():
    """Verify disclaimer is always present in output."""
    from safe_analysis import wrap_output, SYNTHETIC_POC_DISCLAIMER
    
    test_result = "Disease: Flu\nSymptoms: fever, cough"
    wrapped = wrap_output(test_result)
    
    # Disclaimer should appear at start AND end
    assert wrapped.startswith(SYNTHETIC_POC_DISCLAIMER)
    assert wrapped.rstrip().endswith(SYNTHETIC_POC_DISCLAIMER)
    assert test_result in wrapped
```

**Test Execution (after implementation):**
```bash
cd medical_data_poc
python -m pytest test_analysis_safety.py -v
```

**Expected Output:**
```
test_analysis_safety.py::test_rejects_legacy_dataset_csv PASSED
test_analysis_safety.py::test_accepts_synthetic_files PASSED
test_analysis_safety.py::test_disclaimer_wrapper PASSED
```

---

## Files to Create / Modify

### New Files (will be created during implementation)

| File | Purpose | Lines (est.) |
|------|---------|--------------|
| `safe_analysis.py` | Disclaimer wrapper utility | 20-30 |
| `test_analysis_safety.py` | Unit tests for safety constraints | 80-100 |

### Modified Files

| File | Changes | Impact |
|------|---------|--------|
| `medical_analysis.py` | (1) Add `load_synthetic_data()` function; (2) Replace legacy CSV reads; (3) Wrap output with disclaimer | ~30-50 new lines, ~10-15 lines removed |

### No Changes / Legacy

| File | Status |
|------|--------|
| `dataset.csv` | Unused (legacy, not loaded) |
| `Symptom-severity.csv` | Unused (legacy, not loaded) |

---

## Approval Gates (Law 5)

Before proceeding to implementation, the following must be approved:

- [ ] **Disclaimer Text:** Is the disclaimer clear, non-alarmist, and legally appropriate?
- [ ] **Data Loading Logic:** Does the rejection of legacy files match the intent?
- [ ] **Test Cases:** Do the unit tests adequately verify the safety constraints?
- [ ] **Impact on Existing Code:** Are there any external dependencies on the old API?

---

## Law 5 Status

✅ **Decision trail documented.**  
⏳ **Awaiting approval.**  
❌ **Code NOT written until approval received.**

---

**Next Step:** User review of this plan. Approval required before Step 2 (implementation).
