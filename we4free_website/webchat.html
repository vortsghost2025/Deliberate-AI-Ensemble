<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Emergency Contact - WE4Free</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .webchat-container {
            max-width: 600px;
            width: 100%;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        .status-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-bottom: 15px;
        }
        .contact-form {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }
        .submit-btn {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        .submit-btn:hover {
            background: #5568d3;
        }
        .submit-btn:active {
            transform: scale(0.98);
        }
        .submit-btn:disabled {
            background: #999;
            cursor: not-allowed;
        }
        .emergency-notice {
            background: #ff6b6b;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            text-align: center;
        }
        .emergency-notice strong {
            display: block;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        .emergency-links {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        .emergency-links a {
            background: rgba(0, 0, 0, 0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
        }
        .back-link {
            text-align: center;
            margin-top: 20px;
        }
        .back-link a {
            color: white;
            text-decoration: none;
            font-size: 0.95rem;
        }
        .success-message {
            background: #4caf50;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            display: none;
        }
        .success-message.show {
            display: block;
        }
        .offline-notice {
            background: rgba(255, 152, 0, 0.2);
            border: 2px solid #ff9800;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }
        .offline-notice.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="webchat-container">
        <div class="header">
            <h1>üí¨ Emergency Contact Form</h1>
            <div class="status-badge" id="status-badge">üì° Checking connection...</div>
        </div>

        <div class="emergency-notice">
            <strong>üö® IMMEDIATE DANGER?</strong>
            <p>If you're in immediate danger, call emergency services now:</p>
            <div class="emergency-links">
                <a href="tel:911">üìû 911</a>
                <a href="tel:988">üìû 988</a>
                <a href="tel:711">TTY 711</a>
            </div>
        </div>

        <div class="offline-notice" id="offline-notice">
            ‚ö†Ô∏è You're offline. This form submits when you reconnect.
        </div>

        <div class="success-message" id="success-message">
            ‚úÖ <strong>Message Queued</strong><br>
            Your message will be sent when connection is restored.<br>
            If urgent, please call 911 or 988.
        </div>

        <form class="contact-form" id="contact-form">
            <div class="form-group">
                <label for="urgency">Urgency Level *</label>
                <select id="urgency" name="urgency" required>
                    <option value="">Select urgency...</option>
                    <option value="immediate">üî¥ Immediate - Life threatening</option>
                    <option value="urgent">üü† Urgent - Need help soon</option>
                    <option value="standard">üü¢ Standard - General inquiry</option>
                </select>
            </div>

            <div class="form-group">
                <label for="contact">Contact Method (Optional)</label>
                <input type="text" id="contact" name="contact" placeholder="Phone, email, or leave blank">
                <small style="display: block; margin-top: 5px; color: #777;">
                    Only needed if you want us to reach back. You can remain anonymous.
                </small>
            </div>

            <div class="form-group">
                <label for="province">Province/Territory *</label>
                <select id="province" name="province" required>
                    <option value="">Select your location...</option>
                    <option value="BC">British Columbia</option>
                    <option value="AB">Alberta</option>
                    <option value="SK">Saskatchewan</option>
                    <option value="MB">Manitoba</option>
                    <option value="ON">Ontario</option>
                    <option value="QC">Quebec</option>
                    <option value="NB">New Brunswick</option>
                    <option value="NS">Nova Scotia</option>
                    <option value="PE">Prince Edward Island</option>
                    <option value="NL">Newfoundland and Labrador</option>
                    <option value="YT">Yukon</option>
                    <option value="NT">Northwest Territories</option>
                    <option value="NU">Nunavut</option>
                    <option value="OTHER">Outside Canada</option>
                </select>
            </div>

            <div class="form-group">
                <label for="message">What's happening? *</label>
                <textarea id="message" name="message" required placeholder="Describe your situation. We're here to help."></textarea>
            </div>

            <button type="submit" class="submit-btn" id="submit-btn">
                üì§ Send Message
            </button>

            <small style="display: block; margin-top: 15px; color: #777; text-align: center;">
                üîí This form does not store data on servers. Messages are logged locally for offline support.
            </small>
        </form>

        <div class="back-link">
            <a href="/resources.html">‚Üê Back to Resources</a>
        </div>
    </div>

    <script>
    // ==============================================
    // WE4Free Webchat Fallback
    // Offline-capable contact form
    // ==============================================

    const statusBadge = document.getElementById('status-badge');
    const offlineNotice = document.getElementById('offline-notice');
    const successMessage = document.getElementById('success-message');
    const contactForm = document.getElementById('contact-form');
    const submitBtn = document.getElementById('submit-btn');

    // Check online status
    function updateOnlineStatus() {
        if (navigator.onLine) {
            statusBadge.textContent = '‚úÖ Online - Form ready';
            statusBadge.style.background = 'rgba(76, 175, 80, 0.3)';
            offlineNotice.classList.remove('show');
        } else {
            statusBadge.textContent = 'üì¥ Offline - Will queue message';
            statusBadge.style.background = 'rgba(255, 152, 0, 0.3)';
            offlineNotice.classList.add('show');
        }
    }

    // Auto-detect province from IndexedDB if available
    async function autoFillProvince() {
        try {
            const detectedProvince = localStorage.getItem('we4free_province');
            if (detectedProvince) {
                document.getElementById('province').value = detectedProvince;
                console.log('[WE4Free Webchat] Auto-filled province:', detectedProvince);
            }
        } catch (e) {
            // Silent fail if storage unavailable
        }
    }

    // Handle form submission
    contactForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = {
            timestamp: Date.now(),
            urgency: document.getElementById('urgency').value,
            contact: document.getElementById('contact').value,
            province: document.getElementById('province').value,
            message: document.getElementById('message').value,
            online: navigator.onLine,
            user_agent: navigator.userAgent
        };

        // Disable submit button
        submitBtn.disabled = true;
        submitBtn.textContent = 'üì§ Sending...';

        try {
            // Store in IndexedDB for offline queue
            if (typeof WE4FreeDB !== 'undefined' && WE4FreeDB.db) {
                await WE4FreeDB.db.table('sync_status').put({
                    province_code: `webchat_${Date.now()}`,
                    last_sync: formData.timestamp,
                    pending: !navigator.onLine,
                    state: JSON.stringify(formData)
                });

                console.log('[WE4Free Webchat] Message queued locally');
            }

            // If online, attempt to log to console (no actual server endpoint yet)
            if (navigator.onLine) {
                console.log('[WE4Free Webchat] Message submitted:', formData);
                // TODO: Add actual HTTP POST to server endpoint when backend exists
            }

            // Show success
            contactForm.style.display = 'none';
            successMessage.classList.add('show');

            // Log success
            console.log('[WE4Free Webchat] Form submission successful');

            // Redirect back to resources after 5 seconds
            setTimeout(() => {
                window.location.href = '/resources.html';
            }, 5000);

        } catch (error) {
            console.error('[WE4Free Webchat] Submission failed:', error);
            alert('Form submission failed. Please try calling 988 instead.');
            submitBtn.disabled = false;
            submitBtn.textContent = 'üì§ Send Message';
        }
    });

    // Listen for online/offline events
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);

    // Initialize
    updateOnlineStatus();
    autoFillProvince();

    console.log('[WE4Free Webchat] Form initialized');
    </script>
</body>
</html>
