<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WE4FREE Genomics Analysis Platform</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      color: white;
      text-align: center;
      margin-bottom: 10px;
      font-size: 2.5em;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .subtitle {
      color: rgba(255,255,255,0.9);
      text-align: center;
      margin-bottom: 30px;
      font-size: 1.1em;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .card h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 1.5em;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .workflow-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .workflow-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .workflow-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 12px rgba(0,0,0,0.2);
    }

    .workflow-card h3 {
      margin-bottom: 10px;
      font-size: 1.3em;
    }

    .workflow-card p {
      opacity: 0.9;
      margin-bottom: 15px;
      line-height: 1.5;
    }

    .workflow-card .meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.9em;
      opacity: 0.8;
    }

    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #5568d3;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: 600;
    }

    .status.running {
      background: #fef3c7;
      color: #92400e;
    }

    .status.completed {
      background: #d1fae5;
      color: #065f46;
    }

    .status.failed {
      background: #fee2e2;
      color: #991b1b;
    }

    .result-box {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }

    .result-box pre {
      margin: 0;
      white-space: pre-wrap;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      margin-top: 10px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      border-radius: 4px;
      transition: width 0.3s;
    }

    .agent-status {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }

    .agent-badge {
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 0.9em;
    }

    .agent-badge.active {
      background: #dbeafe;
      border-color: #3b82f6;
    }

    #log {
      max-height: 300px;
      overflow-y: auto;
      background: #1f2937;
      color: #10b981;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.85em;
      line-height: 1.5;
    }

    .privacy-badge {
      display: inline-block;
      background: #fef3c7;
      color: #92400e;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
      margin-left: 10px;
    }

    .privacy-badge.hipaa {
      background: #dbeafe;
      color: #1e40af;
    }

    .privacy-badge.federated {
      background: #d1fae5;
      color: #065f46;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß¨ WE4FREE Genomics Analysis Platform</h1>
    <p class="subtitle">Distributed, Privacy-Preserving Multi-Agent Genomics Workflows</p>

    <!-- Workflow Templates -->
    <div class="card">
      <h2>Available Workflows</h2>
      <div class="workflow-grid">
        <div class="workflow-card" onclick="runRareDiseaseWorkflow()">
          <h3>üî¨ Rare Disease Diagnostic</h3>
          <p>End-to-end pipeline: phenotype extraction ‚Üí variant calling ‚Üí prioritization ‚Üí interpretation</p>
          <div class="meta">
            <span>~30 sec</span>
            <span class="privacy-badge hipaa">HIPAA Compliant</span>
          </div>
        </div>

        <div class="workflow-card" onclick="runFederatedLearningWorkflow()">
          <h3>üîê Federated Learning</h3>
          <p>Privacy-preserving collaborative model training. Data stays local, only gradients shared.</p>
          <div class="meta">
            <span>~60 sec</span>
            <span class="privacy-badge federated">Federated</span>
          </div>
        </div>

        <div class="workflow-card" onclick="runGWASWorkflow()">
          <h3>üìä GWAS Analysis</h3>
          <p>Large-scale genotype-phenotype association discovery using distributed map/reduce.</p>
          <div class="meta">
            <span>~120 sec</span>
            <span class="privacy-badge">Standard</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Active Agents -->
    <div class="card">
      <h2>Active Genomics Agents</h2>
      <div class="agent-status" id="agent-status">
        <div class="agent-badge">Variant Caller: idle</div>
        <div class="agent-badge">Phenotype Extractor: idle</div>
        <div class="agent-badge">Variant Prioritizer: idle</div>
        <div class="agent-badge">Federated Learner: idle</div>
        <div class="agent-badge">Interpretability: idle</div>
      </div>
    </div>

    <!-- Workflow Results -->
    <div class="card">
      <h2>Workflow Results</h2>
      <div id="results">
        <p style="color: #6b7280;">No workflows executed yet. Select a workflow above to get started.</p>
      </div>
    </div>

    <!-- Activity Log -->
    <div class="card">
      <h2>Activity Log</h2>
      <div id="log"></div>
    </div>
  </div>

  <!-- Dependencies -->
  <script src="swarm-registry.js?v=4.0.0"></script>
  <script src="task-queue.js?v=4.0.0"></script>
  <script src="distributed-compute.js?v=4.0.0"></script>
  <script src="genomics-agent-roles.js?v=7.0.0"></script>
  <script src="genomics-workflows.js?v=7.0.0"></script>

  <script>
    // ========================================================================
    // INITIALIZATION
    // ========================================================================

    let taskQueue;
    let registry;
    let computeEngine;
    let workflowOrchestrator;
    let genomicsAgents = [];

    function log(message) {
      const logEl = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      logEl.innerHTML += `[${timestamp}] ${message}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function init() {
      log('üöÄ Initializing WE4FREE Genomics Platform...');

      // Create swarm infrastructure
      registry = new SwarmRegistry();
      taskQueue = new TaskQueue(registry);
      computeEngine = new DistributedCompute(taskQueue, registry);

      // Create genomics agents
      const agentRoles = [
        GenomicsAgentRole.VARIANT_CALLER,
        GenomicsAgentRole.PHENOTYPE_EXTRACTOR,
        GenomicsAgentRole.VARIANT_PRIORITIZER,
        GenomicsAgentRole.FEDERATED_LEARNER,
        GenomicsAgentRole.INTERPRETABILITY
      ];

      agentRoles.forEach((role, idx) => {
        const agentId = `genomics-agent-${idx}`;
        const agent = GenomicsAgentFactory.createAgent(role, agentId, registry, taskQueue);
        genomicsAgents.push(agent);
        registry.registerAgent(agentId, role);
        log(`‚úÖ Created ${role} agent: ${agentId}`);
      });

      // Create workflow orchestrator
      workflowOrchestrator = new GenomicsWorkflowOrchestrator(taskQueue, registry, computeEngine);

      // Start task processing
      startTaskProcessing();

      log('‚úÖ Genomics Platform initialized');
      log('üìã Ready to execute workflows');
    }

    // ========================================================================
    // TASK PROCESSING
    // ========================================================================

    function startTaskProcessing() {
      setInterval(() => {
        genomicsAgents.forEach(async agent => {
          if (agent.state === 'idle') {
            // Claim next available task
            const claim = taskQueue.claimNextTask(agent.agentId);
            if (claim.success) {
              const task = claim.task;
              log(`üîÑ ${agent.role} processing: ${task.type}`);

              // Update UI
              updateAgentStatus(agent.role, 'active');

              // Process task
              const result = await agent.processTask(task);

              // Complete task
              taskQueue.completeTask(task.id, result);

              // Update UI
              updateAgentStatus(agent.role, 'idle');
            }
          }
        });
      }, 100);
    }

    function updateAgentStatus(role, status) {
      const badges = document.querySelectorAll('.agent-badge');
      badges.forEach(badge => {
        if (badge.textContent.toLowerCase().includes(role.toLowerCase())) {
          badge.className = status === 'active' ? 'agent-badge active' : 'agent-badge';
          const parts = badge.textContent.split(':');
          badge.textContent = `${parts[0]}: ${status}`;
        }
      });
    }

    // ========================================================================
    // WORKFLOWS
    // ========================================================================

    async function runRareDiseaseWorkflow() {
      log('üî¨ Starting Rare Disease Diagnostic Workflow...');

      // Mock patient data
      const patientData = {
        patientId: 'PATIENT-001',
        clinicalNotes: 'Patient presents with seizures, global developmental delay, and hypotonia.',
        structuredData: { age: 5, sex: 'F' },
        sequencingData: 'mock-bam-file',
        region: 'chr2'
      };

      try {
        const result = await workflowOrchestrator.executeRareDiseaseWorkflow(patientData);
        displayWorkflowResult('Rare Disease Diagnostic', result);
        log(`‚úÖ Workflow completed: ${result.workflowId} (${result.duration}ms)`);
      } catch (error) {
        log(`‚ùå Workflow failed: ${error.message}`);
      }
    }

    async function runFederatedLearningWorkflow() {
      log('üîê Starting Federated Learning Workflow...');

      // Mock model config
      const modelConfig = {
        initialWeights: {
          layer1: Array(10).fill(0).map(() => Math.random()),
          layer2: Array(10).fill(0).map(() => Math.random())
        },
        rounds: 3,
        privacyBudget: 1.0
      };

      // Mock participant data (3 institutions)
      const participantData = [
        { institution: 'Hospital A', data: Array(100).fill(0).map(() => ({ x: Math.random(), y: Math.random() })) },
        { institution: 'Hospital B', data: Array(100).fill(0).map(() => ({ x: Math.random(), y: Math.random() })) },
        { institution: 'Research Center C', data: Array(100).fill(0).map(() => ({ x: Math.random(), y: Math.random() })) }
      ];

      try {
        const result = await workflowOrchestrator.executeFederatedLearningWorkflow(modelConfig, participantData);
        displayWorkflowResult('Federated Learning', result);
        log(`‚úÖ Workflow completed: ${result.workflowId} (${result.duration}ms)`);
      } catch (error) {
        log(`‚ùå Workflow failed: ${error.message}`);
      }
    }

    async function runGWASWorkflow() {
      log('üìä Starting GWAS Analysis Workflow...');

      // Mock cohort data (50 samples)
      const cohortData = Array(50).fill(0).map((_, i) => ({
        id: `SAMPLE-${i}`,
        sequencingData: 'mock-vcf',
        phenotype: Math.random() > 0.5 ? 'case' : 'control'
      }));

      const phenotype = 'disease-status';

      try {
        const result = await workflowOrchestrator.executeGWASWorkflow(cohortData, phenotype);
        displayWorkflowResult('GWAS Analysis', result);
        log(`‚úÖ Workflow completed: ${result.workflowId} (${result.duration}ms)`);
      } catch (error) {
        log(`‚ùå Workflow failed: ${error.message}`);
      }
    }

    function displayWorkflowResult(workflowName, result) {
      const resultsEl = document.getElementById('results');
      resultsEl.innerHTML = `
        <h3>${workflowName} <span class="status completed">Completed</span></h3>
        <p><strong>Workflow ID:</strong> ${result.workflowId}</p>
        <p><strong>Duration:</strong> ${result.duration}ms</p>
        <div class="result-box">
          <pre>${JSON.stringify(result, null, 2)}</pre>
        </div>
      `;
    }

    // ========================================================================
    // START
    // ========================================================================

    window.addEventListener('load', init);
  </script>
</body>
</html>
